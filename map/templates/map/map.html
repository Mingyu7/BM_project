{% extends 'listings/base.html' %}

{% block title %}지도{% endblock %}

{% block content %}
<div id="map" style="width:100%;height:900px;"></div>

<script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey={{ api_key }}&libraries=services"></script>
<script>
    var mapContainer = document.getElementById('map');
    var map;
    var properties = {{ properties_json|safe }};

    // 마커를 표시하는 함수
    function displayMarkers(map) {
        properties.forEach(function(prop) {
            var marker = new kakao.maps.Marker({
                map: map,
                position: new kakao.maps.LatLng(prop.latitude, prop.longitude)
            });

            var infowindow = new kakao.maps.InfoWindow({
                content: `<div style="padding:5px;font-size:12px;">
                              <strong>${prop.title}</strong><br>
                              가격: ${prop.price}원<br>
                              <a href="/listings/${prop.pk}/">상세보기</a>
                          </div>`,
                removable: true
            });

            kakao.maps.event.addListener(marker, 'click', function() {
                infowindow.open(map, marker);
            });
        });
    }

    // HTML5의 geolocation으로 사용할 수 있는지 확인합니다
    if (navigator.geolocation) {
        // GeoLocation을 이용해서 접속 위치를 얻어옵니다
        navigator.geolocation.getCurrentPosition(function(position) {
            var lat = position.coords.latitude; // 위도
            var lon = position.coords.longitude; // 경도
            var locPosition = new kakao.maps.LatLng(lat, lon);

            var mapOption = {
                center: locPosition,
                level: 7
            };
            map = new kakao.maps.Map(mapContainer, mapOption);
            displayMarkers(map);

        }, function(error) { // 위치 정보 얻기 실패 시
            console.warn("Geolocation failed: " + error.message);
            var mapOption = {
                center: new kakao.maps.LatLng(37.5665, 126.9780), // 서울 시청
                level: 8
            };
            map = new kakao.maps.Map(mapContainer, mapOption);
            displayMarkers(map);
        });
    } else { // HTML5의 GeoLocation을 사용할 수 없을때
        console.warn("Geolocation is not supported by this browser.");
        var mapOption = {
            center: new kakao.maps.LatLng(37.5665, 126.9780), // 서울 시청
            level: 8
        };
        map = new kakao.maps.Map(mapContainer, mapOption);
        displayMarkers(map);
    }
</script>
{% endblock %}
