{% extends "listings/base.html" %}

{% block content %}
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="property-form-container p-4 border rounded shadow-sm">
                <h2 class="mb-4">매물 등록</h2>

                <button type="button" id="btn-set-coords" class="btn btn-secondary mb-3" onclick="modalMap()">
                    지도에서 위치 선택
                </button>

                <form method="post" enctype="multipart/form-data">
                    {% csrf_token %}
                    {% for field in form %}
                        {% if field.name != "latitude" and field.name != "longitude" %}
                            <div class="mb-3">
                                <label for="{{ field.id_for_label }}" class="form-label">{{ field.label }}</label>
                                {{ field }}
                                {% for error in field.errors %}
                                    <div class="alert alert-danger mt-1">{{ error }}</div>
                                {% endfor %}
                            </div>
                        {% else %}
                            {{ field }} {# 숨겨진 input #}
                        {% endif %}
                    {% endfor %}
                    <button type="submit" class="btn btn-primary w-100">등록</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- 모달 -->
<div id="modal-container" class="modal-container" style="
    position: fixed; width: 100%; height: 100%; left: 0; top: 0; z-index: 999;
    display: none; background-color: rgba(0,0,0,0.4);
">
    <div id="map-in-modal" class="map-in-modal" style="
        position: absolute; left: 10%; top: 10%; width: 80%; height: 80%; background: #fff; border-radius: 8px; overflow: hidden;
    ">
        <!-- 상단 바: 좌표 + 닫기 -->
        <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; background: #f5f5f5; border-bottom: 1px solid #ddd;">
            <div id="coords-display" style="font-weight: bold; color: #333;">위도/경도: 없음</div>
            <button id="modal-close-btn" style="
                background: #f44336; color: #fff; border: none;
                border-radius: 50%; width: 30px; height: 30px;
                font-weight: bold; cursor: pointer;
            ">X</button>
        </div>
        <div id="map" style="width:100%; height:calc(100% - 40px);"></div>
    </div>
</div>

<script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey={{ KAKAO_API_KEY }}"></script>
<script>
let marker;
let modal = document.getElementById('modal-container');
let mapInModal = document.getElementById('map-in-modal');
let mapContainer = document.getElementById('map');
let coordsDisplay = document.getElementById('coords-display');
let closeBtn = document.getElementById('modal-close-btn');

let mapOption = {
    center: new kakao.maps.LatLng(37.566789, 126.978440),
    level: 5
};
let map = new kakao.maps.Map(mapContainer, mapOption);

// 모달 열기
function showModal() {
    modal.style.display = "block";

    // 지도 클릭 이벤트
    kakao.maps.event.addListener(map, 'click', clickMarker);

    // 모달 닫기 버튼
    closeBtn.addEventListener('click', hideModal);

    // 모달 외부 클릭 시 닫기
    modal.addEventListener('click', hideModal);
    mapInModal.addEventListener('click', function(e){ e.stopPropagation(); });

    // 지도 재배치
    map.relayout();
}

// 모달 닫기
function hideModal() {
    modal.style.display = 'none';
    if (marker) marker.setMap(null);
}

// 지도 클릭 → 마커 생성 + 좌표 표시 + hidden input
function clickMarker(mouseEvent) {
    let latlng = mouseEvent.latLng;
    let lat = latlng.getLat();
    let lng = latlng.getLng();

    if (marker) marker.setMap(null);

    marker = new kakao.maps.Marker({ position: latlng });
    marker.setMap(map);

    coordsDisplay.textContent = `위도: ${lat.toFixed(8)}, 경도: ${lng.toFixed(8)}`;

    document.getElementById("id_latitude").value = lat.toFixed(8);
    document.getElementById("id_longitude").value = lng.toFixed(8);
}

// 지도 모달 열기
function modalMap() {
    showModal();
}
</script>
{% endblock %}
