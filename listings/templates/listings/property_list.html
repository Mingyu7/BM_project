{% extends 'listings/base.html' %}
{% load humanize %}

{% block title %}매물 목록 - Better My house{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
    <h2>매물 목록</h2>
    <a href="{% url 'listings:property_create' %}" class="btn btn-success">매물 등록</a>
</div>
    <div class="region-nav my-4">
        <ul class="nav nav-pills justify-content-center">
            <li class="nav-item">
                <a class="nav-link {% if not selected_region %}active{% endif %}"
                   href="{% url 'listings:property_index' %}">전체</a>
            </li>
            {% for region_value, region_display in regions %}
            <li class="nav-item">
                <a class="nav-link {% if selected_region == region_value %}active{% endif %}"
                   href="?region={{ region_value }}">{{ region_display }}</a>
            </li>
            {% endfor %}
        </ul>
    </div>

    <div class="property-list grid grid-cols-3 gap-4">
        {% for property in properties %}
        <div class="property-card border rounded p-3 shadow">
            {% if property.image %}
            <img src="{{ property.image.url }}" alt="{{ property.title }}" class="property-thumbnail">

            {% endif %}
            <h3 class="text-lg font-bold mt-2">{{ property.title }}
                {% if user.is_authenticated %}
                <button class="bookmark-btn {% if property.id in bookmarked_properties %}active{% endif %}"
                        data-property-id="{{ property.id }}">
                    &#9733; <!-- 별 모양 아이콘 (★) -->
                </button>
                {% endif %}
            </h3>

            <p><strong>지역:</strong> {{ property.region }}</p>
            <p><strong>작성자:</strong> {{ property.author.username }}</p>
            <p><strong>주소:</strong>{{property.address}}</p>
            <p class="card-text">설명 : {{ property.description|truncatechars:100 }}</p>
            <a href="{% url 'listings:property_detail' property.pk %}" class="text-blue-500">상세보기</a><br>
            {% if user.is_authenticated and user == property.author %}
            <a href="{% url 'listings:property_update' property.id %}" class="btn btn-primary btn-sm">수정</a>
            <a href="{% url 'listings:property_delete' property.id %}" class="btn btn-danger btn-sm">삭제</a>
            {% endif %}
        </div>
        {% empty %}
        <p>등록된 매물이 없습니다.</p>
        {% endfor %}
    </div>
</div>

<style>
    .bookmark-btn {
        background: none;
        border: none;
        color: #ccc; /* 비활성 상태 색상 */
        cursor: pointer;
        font-size: 24px;
        margin-left: 5px; /* 제목과의 간격 */
    }
    .bookmark-btn.active {
        color: #ffc107; /* 활성 상태 색상 (노란색) */
    }
</style>

<script>
    // CSRF 토큰을 가져오는 함수 (Django에서 POST 요청 시 필수)
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    // 모든 북마크 버튼에 이벤트 리스너 추가
    document.addEventListener('DOMContentLoaded', function() {
        console.log('property_list.html: DOMContentLoaded fired.');
        document.querySelectorAll('.bookmark-btn').forEach(button => {
            console.log('property_list.html: Attaching event listener to button:', button);
            button.addEventListener('click', function(event) {
                event.preventDefault(); // Prevent default form submission
                console.log('property_list.html: Bookmark button clicked.', this);

                const propertyId = this.dataset.propertyId;
                const url = `/bookmarks/toggle/${propertyId}/`;

                console.log('property_list.html: Sending fetch request to:', url);
                fetch(url, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrftoken,
                        'X-Requested-With': 'XMLHttpRequest', // Important for Django to recognize AJAX
                        'Content-Type': 'application/json' // Specify content type if sending JSON
                    },
                    // body: JSON.stringify({}) // Send an empty JSON object if no data is needed
                })
                .then(response => {
                    console.log('property_list.html: Received response:', response);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('property_list.html: Received data:', data);
                    if (data.bookmarked) {
                        console.log('property_list.html: Property bookmarked. Adding active class.');
                        this.classList.add('active');
                    } else {
                        console.log('property_list.html: Property unbookmarked. Removing active class.');
                        this.classList.remove('active');
                    }
                })
                .catch(error => console.error('property_list.html: Error toggling bookmark:', error));
            });
        });
    });
</script>
{% endblock %}