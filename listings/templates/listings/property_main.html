{% extends 'listings/base.html' %}
{% load humanize %}

{% block title %}홈 - Better My house{% endblock %}

{% block content %}
<div class="hero-section text-center text-white py-5 mb-4">
    <div class="hero-overlay">
        <h1 class="display-5 fw-bold">어떤 집을 찾고 계세요?</h1>
        <div class="col-lg-6 mx-auto">
            <p class="lead mb-4">원룸, 투룸, 아파트, 오피스텔까지. 원하는 매물을 찾아보세요.</p>
            <button class="btn btn-primary" type="submit">검색</button>
            </form>
            
        </div>
        </div>
    </div>
</div>



<h2>매물 목록</h2>
<div class="property-list">
    {% for property in properties %}
    <div class="property-card border rounded p-3 shadow">
        {% if property.image %}
        <img src="{{ property.image.url }}" alt="{{ property.title }}" class="property-thumbnail">
        {% endif %}
        <h3 class="text-lg font-bold mt-2">{{ property.title }}
            {% if user.is_authenticated %}
                <button class="bookmark-btn {% if property.id in bookmarked_properties %}active{% endif %}" data-property-id="{{ property.id }}">
                    &#9733; <!-- 별 모양 아이콘 (★) -->
                </button>
            {% endif %}
        </h3>
        <p>{{ property.description|truncatewords:20 }}</p>
        <p>지역: {{ property.region }}</p>
        <p>작성자: {{ property.author.username }}</p>
        <p>가격:
            {% if property.price %}
            {{ property.price|intcomma }} 원
            {% else %}
            가격 미정
            {% endif %}
        </p>
        <a href="{% url 'listings:property_detail' property.pk %}" class="text-blue-500">상세보기</a>
        {% if user.is_authenticated and user == property.author %}

        {% endif %}
    </div>
    {% empty %}
    <p>등록된 매물이 없습니다.</p>
    {% endfor %}
</div>

<div class="row g-5">
    <div class="col-md-4">
        <div class="info-section">
            <h4><a href="{% url 'announcements:news' %}">부동산 뉴스</a></h4>
            <ul class="list-unstyled">
                {% for item in news_list %}
                <li>
                    <a href="#">{{ item.title|truncatechars:25 }}</a>
                    <span class="date">{{ item.date|date:"m.d" }}</span>
                </li>
                {% endfor %}
            </ul>
        </div>
    </div>
    <div class="col-md-4">
        <div class="info-section">
            <h4><a href="{% url 'weather:weather' %}">오늘의 날씨</a></h4>
            <ul class="list-unstyled">
                {% for item in weather_list %}
                <li class="d-flex align-items-center mb-2">
                    <i class="{{ item.icon }} fa-fw me-2 text-muted"></i>
                    <span>{{ item.location }}: {{ item.temp }}, {{ item.condition }}</span>
                </li>
                {% endfor %}
            </ul>
        </div>
    </div>
    <div class="col-md-4">
        <div class="info-section">
            <h4><a href="{% url 'announcements:announcements' %}">공지사항</a></h4>
            <ul class="list-unstyled">
                {% for item in announcements_list %}
                <li>
                    <a href="{% url 'announcements:announcement_detail' item.pk %}">{{ item.title|truncatechars:25 }}</a>
                    <span class="date">{{ item.date|date:"m.d" }}</span>
                </li>
                {% endfor %}
            </ul>
        </div>
    </div>
</div>
</div>

<style>
    .bookmark-btn {
        background: none;
        border: none;
        color: #ccc; /* 비활성 상태 색상 */
        cursor: pointer;
        font-size: 24px;
        margin-left: 5px; /* 제목과의 간격 */
    }
    .bookmark-btn.active {
        color: #ffc107; /* 활성 상태 색상 (노란색) */
    }
</style>

<script>
// CSRF 토큰을 가져오는 함수 (Django에서 POST 요청 시 필수)
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
const csrftoken = getCookie('csrftoken');

// 모든 북마크 버튼에 이벤트 리스너 추가
document.querySelectorAll('.bookmark-btn').forEach(button => {
    button.addEventListener('click', function() {
        const propertyId = this.dataset.propertyId;
        const url = `/bookmarks/toggle/${propertyId}/`;

        fetch(url, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrftoken,
                'Content-Type': 'application/json'
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.bookmarked) {
                // 북마크 성공 시 'active' 클래스 추가
                this.classList.add('active');
            } else {
                // 북마크 취소 시 'active' 클래스 제거
                this.classList.remove('active');
            }
        })
        .catch(error => console.error('Error:', error));
    });
});
</script>
{% endblock %}